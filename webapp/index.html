<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Форма заявки</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding: 15px;
      color: var(--tg-theme-text-color);
      background: var(--tg-theme-bg-color);
    }
    h1, h2 {
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    textarea {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid var(--tg-theme-hint-color);
      border-radius: 5px;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
    }
    .radio-group label {
      display: block;
      margin-bottom: 8px;
    }
    .radio-group input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
<h1>Форма подачи заявки</h1>

<div class="form-group">
  <label for="fio">ФИО:</label>
  <input type="text" id="fio" placeholder="Иванов Иван Иванович">
</div>

<div class="form-group">
  <label for="phone">Номер телефона:</label>
  <input type="tel" id="phone" placeholder="+7 (999) 123-45-67">
</div>

<div class="form-group">
  <label for="email">Электронная почта:</label>
  <input type="email" id="email" placeholder="example@mail.com">
</div>

<div class="form-group">
  <label>Адрес подключения:</label>
  <textarea id="address" rows="3" placeholder="г. Москва, ул. Ленина, д. 1, кв. 1"></textarea>
</div>

<div class="form-group">
  <label>Способ оформления:</label>
  <div class="radio-group">
    <label><input type="radio" name="application_type" value="online" checked> Онлайн</label>
    <label><input type="radio" name="application_type" value="in_person"> Личное посещение</label>
  </div>
</div>

<div class="form-group">
  <h2>Выберите тариф:</h2>
  <div id="tariffs-container" class="radio-group">
    <p>Загрузка тарифов...</p>
  </div>
</div>

<script>
  // Initialize Telegram Web App object
  const tg = window.Telegram.WebApp;
  tg.MainButton.show();
  tg.MainButton.setText("Отправить данные");
  tg.expand();

  // Function to load tariffs when the page is ready
  window.addEventListener('DOMContentLoaded', () => {
    fetch('/api/tariffs')
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.json();
            })
            .then(tariffs => {
              const container = document.getElementById('tariffs-container');
              container.innerHTML = ''; // Clear "Loading..." message

              tariffs.forEach((tariff, index) => {
                const tariffElement = document.createElement('label');

                const input = document.createElement('input');
                input.type = 'radio';
                input.id = tariff.id;
                input.name = 'tariff';
                input.value = tariff.name;
                // Select the first tariff by default
                if (index === 0) {
                  input.checked = true;
                }

                // Use the first available speed's price for the label
                const price = tariff.speeds.length > 0 ? tariff.speeds[0].price : 'N/A';
                const labelText = document.createTextNode(` ${tariff.name} (${price} ₽/мес)`);

                tariffElement.appendChild(input);
                tariffElement.appendChild(labelText);
                container.appendChild(tariffElement);
              });
            })
            .catch(error => {
              const container = document.getElementById('tariffs-container');
              container.innerHTML = '<p>Не удалось загрузить тарифы. Пожалуйста, попробуйте позже.</p>';
              console.error('Error fetching tariffs:', error);
              tg.MainButton.hide(); // Hide button if tariffs fail to load
            });
  });

  // Event handler for the main Telegram button
  tg.onEvent('mainButtonClicked', () => {
    const selectedTariff = document.querySelector('input[name="tariff"]:checked');

    // Gather all data from the form
    const data = {
      fio: document.getElementById('fio').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      address: document.getElementById('address').value,
      application_type: document.querySelector('input[name="application_type"]:checked').value,
      tariff: selectedTariff ? selectedTariff.value : "Не выбран"
    };

    // Send data as a JSON string to the bot
    tg.sendData(JSON.stringify(data));
  });
</script>
</body>
</html>
